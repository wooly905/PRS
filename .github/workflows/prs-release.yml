name: prs-release
on:
  workflow_dispatch

jobs:
  build-test-publish:
    runs-on: windows-latest

    env:
      Solution_Name: PRS.sln
      Project_Path: src/PRS.csproj
      Tests_Path: tests/PRS.Tests.csproj

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    # Install the .NET Core workload
    - name: Install .NET 8.0
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore ${{ env.Solution_Name }}

    - name: Build solution
      run: dotnet build ${{ env.Solution_Name }} -c Release --no-restore

    - name: Run unit tests
      run: dotnet test ${{ env.Tests_Path }} --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"

    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Unit Test Results
        path: '**/test-results.trx'
        reporter: dotnet-trx
        fail-on-error: true

    - name: Pack NuGet package
      run: dotnet pack ${{ env.Project_Path }} -c Release --no-build --output ./nupkg

    - name: Display package info
      shell: pwsh
      run: |
        $package = Get-ChildItem ./nupkg/*.nupkg | Select-Object -First 1
        Write-Host "Package created: $($package.Name)"
        Write-Host "Package size: $($package.Length / 1MB) MB"
        Write-Host "Package path: $($package.FullName)"

    - name: Push to NuGet.org
      run: dotnet nuget push ./nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
